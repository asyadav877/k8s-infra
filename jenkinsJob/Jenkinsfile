pipeline {
    agent any
    stages {
        stage('Checkout Repo'){
            steps{
                sh 'echo   "Not checking out the repo since already inside that repo"'
                sh 'ls -la'
            }
        }

        stage('Write to File') {
            steps {
                dir("automatedTerraform/resource/${resource}"){
                    script {
                        def content = params.tfvars
                        writeFile file: "terraform.tfvars", text: content
                    }
                    sh "cat terraform.tfvars"
                }
                

                
            }
        }

        stage('Initialising the terraform'){
            steps {
                dir("automatedTerraform/resource/${resource}"){
                    sh '/usr/local/bin/terraform init -reconfigure -no-color'
                }

            }
        }

        stage('Planning the terraforn resource'){
            steps {
                dir("automatedTerraform/resource/${resource}"){
                    sh '/usr/local/bin/terraform plan -no-color' 
                }

            }
        }

        stage('Proceed to create resource or abort'){
            steps{
                script {
                    def input = input(
                        id: 'userInput',
                        message: 'Proceed with the pipeline?',
                        parameters: [
                            [$class: 'BooleanParameterDefinition', defaultValue: true, description: 'Proceed?', name: 'PROCEED']
                        ]
                    )
                    if (!userInput.PROCEED) {
                        error('Pipeline aborted by user')
                    }
                }
            }
        }

        stage('Creating Resource ...'){
            steps {
                dir("automatedTerraform/resource/${resource}"){
                    sh '/usr/local/bin/terraform apply --auto-approve -no-color'
                }
            }
        }

        stage('Clean Workspace') {
            steps {
                // Clean the workspace
                deleteDir()
            }
        }
    }
}
